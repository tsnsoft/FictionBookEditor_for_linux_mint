<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
 "http://www.w3.org/TR/html4/loose.dtd">
<HTML style="height:100%;">
<HEAD>
 <TITLE>заголовок, который должен быть не виден</TITLE>
 <META http-equiv="X-UA-Compatible" content="IE=6">
 <META http-equiv="Content-Type" content="text/html; charset=utf-8">
 <STYLE>
  body {font-family:Tahoma; font-size:11px;}
  p {margin:0;}
  .delim {width:520px; background-color:#B0B0B0; height:1px; overflow:hidden; margin:0; padding:0;}
  .el_ {width:520px; margin:0; padding:0 1px 0 1px; border:1px solid white; color:black; background-color:white;}
  .el_sel {width:520px; margin:0; padding:0 1px 0 1px; border:1px solid #3399FF; background-color:#3399FF; color:white;}
  .el_active {width:520px; margin:0; padding:0 1px 0 1px; border:1px solid black; background-color:white; color:black;}
  .el_active_sel {width:520px; margin:0; padding:0 1px 0 1px; border:1px solid black; background-color:#3399FF; color:white;}
 </STYLE>
 <SCRIPT>
var fbwBody=window.dialogArguments["fbwBody"];
var mainDoc=window.dialogArguments["mainDocument"];
var mainWin=window.dialogArguments["window"];
var currentElementType="";
var currentTargetElementType="";
var htmlStr="";
var scrolling="no";
var insideSection=false;
var activeElement=null;
var selectionBegin=null;
var selectedElements={};
var mouseTimer=null;
var scrollbarWidth=0,scrollbarHeight=0;
var elementsInAll;
var k;
var selectedElementsCnt=0;
var mouseDown=false;
var ptr2,s1,ptr3,ptr4,ptr5,ptr6,tmpNode,sectionOrPoemOrStanza,prevSectionOrPoemOrStanza;
var marker,el2,el3,el4,el5,el6,el7,el8,el9,previousSection,elemInList,myN_2,elemInMainDoc2;
var parentSectionOrPoemOrStanza_of_elemInMainDoc,sortedElementArray,isElement,newTitleElement;
var markerBegin,markerEnd,saveNext2,saveEl2,titleHtmlStr,kk,kkEl,beginOfBlock,endOfBlock,ttEl;
var needKillDelim,nPtr,nPtr2,attributeSv,flag2,saveEl5,prev,gg,unselElemInListMatchInMainDoc;
var newSection,elemInMainDoc,el8,titleElement,nextSectionOrPoemOrStanza,titleInNextSection;
var newP,thereWasSubtitlesInCite,nPtr3,saveEl2,flag3,flag4,tt,nextTt,sForText;
var foundInlineElementsInP,caseFlag;
var htmlTagByFb2Tag={"emphasis":"EM","strong":"STRONG","sup":"SUP","sub":"SUB","strikethrough":"STRIKE"};
var htmlTagRegExpByFb2Tag={"emphasis":/^(EM|I)$/i, "strong":/^(STRONG|B)$/i, "sup":/^SUP$/i, "sub":/^SUB$/i, "strikethrough":/^STRIKE$/i};
var randomId="elementBrowsing_"+Math.floor((Math.random()*9)).toString()+Math.floor((Math.random()*9)).toString()+Math.floor((Math.random()*9)).toString()+Math.floor((Math.random()*9)).toString()+Math.floor((Math.random()*9)).toString()+Math.floor((Math.random()*9)).toString();
//var re0=new RegExp("((<[^>]*?>)+)?[^<>]){0,36}","i");
var re0=new RegExp("(.{50}).+?$");
var re0_="$1";
var re2=new RegExp("<BR>","gi");
var re2_="</P><P>";
var letterRE=new RegExp(
  "[0-9а-яёa-zÀÁÂÃÄÅÆÇÈÉÊËÌÍÏÐÑÒÓÔÕÖØÙÚÛÜÝÞßàáâãäåæçèéêëìíîïðñòóôõöøùúûüýþÿĀāăĄąĆćĈĉĊċČčĎďĐđĒēĔĕĖėĘęĚěĜĝĞğĠġĢģĤĥĦħĨĩĪīĬĭĮįİıĲĳĴĵĶķĸĹĺĻļĽľĿŀŁłŃńŅņŇňŉŊŋŌōŎŏŐőŒœŔŕŖŗŘřŚśŜŝŞşŠšŢţŤťŦŧŨũŪūŬŭŮůŰűŲųŴŵŶŷŸŹźŻżŽžſƏƒƠơƯưƷǤǥǦǧǨǩǪǫǮǯǺǻǼǽǾǿȘșȚțȨȩəʒ"+
  "ΆΈΉΊΌΎΐΑΒΓΔΕΖΗΘΙΚΛΜΝΞΟΠΡΣΤΥΦΧΨΩΪΫάέήίΰαβγδεζηθικλμνξοπρςστυφχψωϊϋόύώЀЁЂЃЄЅІЇЈЉЊЋЌЍЎЏ"+
  "ѐђѓєѕіїјљњћќѝўџҐґҒғҖҗҚқҜҝҢңҮүҰұҲҳҸҹҺһӘәӨө"+
  "ḀḁḂḃḄḅḆḇḈḉḊḋḌḍḎḏḐḑḒḓḔḕḖḗḘḙḚḛḜḝḞḟḠḡḢḣḤḥḦḧḨḩḪḫḬḭḮḯḰḱḲḳḴḵḶḷḸḹḺḻḼḽḾḿṀṁṂṃṄṅṆṇṈṉṊṋṌṍṎṏṐṑṒṓṔṕṖṗṘṙṚṛṜṝṞṟṠṡṢṣṤṥṦṧṨṩṪṫṬṭṮṯṰṱṲṳṴṵṶṷṸṹṺṻṼṽṾṿẀẁẂẃẄẅẆẇẈẉẊẋẌẍẎẏẐẑẒẓẔẕẖẗẘẙẚẛẠạẢảẤấẦầẨẩẪẫẬậẮắẰằẲẳẴẵẶặẸẹẺẻẼẽẾếỀềỂểỄễỆệỈỉỊịỌọỎỏỐốỒồỔổỖỗỘộỚớỜờỞởỠỡỢợỤụỦủỨứỪừỬửỮữỰựỲỳỴỵỶỷỸỹἀἁἂἃἄἅἆἇἈἉἊἋἌἍἎἏἐἑἒἓἔἕἘἙἚἛἜἝἠἡἢἣἤἥἦἧἨἩἪἫἬἭἮἯἰἱἲἳἴἵἶἷἸἹἺἻἼἽἾἿὀὁὂὃὄὅὈὉὊὋὌὍὐὑὒὓὔὕὖὗὙὛὝὟὠὡὢὣὤὥὦὧὨὩὪὫὬὭὮὯὰάὲέὴήὶίὸόὺύὼώᾀᾁᾂᾃᾄᾅᾆᾇᾈᾉᾊᾋᾌᾍᾎᾏᾐᾑᾒᾓᾔᾕᾖᾗᾘᾙᾚᾛᾜᾝᾞᾟᾠᾡᾢᾣᾤᾥᾦᾧᾨᾩᾪᾫᾬᾭᾮᾯᾰᾱᾲᾳᾴᾶᾷᾸᾹᾺΆᾼ"+
  "ῂῃῄῆῇῈΈῊΉῌ"+
  "ῐῑῒΐῖῗῘῙῚΊῠῡῢΰῤῥῦῧῨῩῪΎῬῲῳῴῶῷῸΌῺΏῼ]","i");
var onlySpacesRegExp=new RegExp("^(&nbsp;| | )*?$","");
var poemOrStanzaRegexp=new RegExp("poem|stanza","i");
var myLinks={};
var nCnt;

function getScrollBarWidthAndHeight() {
 var inner = document.createElement('p');
 inner.style.width = "100%";
 inner.style.height = "200px";

 var outer = document.createElement('div');
 outer.style.position = "absolute";
 outer.style.top = "0px";
 outer.style.left = "0px";
 outer.style.visibility = "hidden";
 outer.style.width = "200px";
 outer.style.height = "150px";
 outer.style.overflow = "hidden";
 outer.appendChild(inner);

 document.getElementById("elementList").appendChild(outer);
 var w1=inner.offsetWidth;
 var h1=inner.offsetHeight;
 outer.style.overflow = 'scroll';
 var w2=inner.offsetWidth;
 var h2=inner.offsetHeight;
 if (w1==w2) w2 = outer.clientWidth;
 if (h1==h2) h2 = outer.clientWidth;
 outer.removeNode(true);

 scrollbarWidth=w1-w2;
 scrollbarHeight=h1-h2;
};

function removeActivityFromActiveElement() {
 if (!activeElement) return;
 if (activeElement.className=="el_active_sel")
  activeElement.className="el_sel";
 else if (activeElement.className=="el_active")
  activeElement.className="el_";
}

function setActivityToElement(activeElement) {
 if (!activeElement) return;
 if (activeElement.className=="el_sel")
  activeElement.className="el_active_sel";
 else if (activeElement.className=="el_")
  activeElement.className="el_active";
}

function getTitleByElement(el) {
 ptr5=el;
 while (ptr5 && ptr5.nodeName!="BODY" &&
        !(ptr5.nodeName=="DIV" && ptr5.className=="title"))
  ptr5=ptr5.parentNode;
 if (!ptr5 || ptr5.nodeName=="BODY") return null;
 return ptr5;
}

function selectElements(selectionBegin,selectionEnd) {

 var currN,evaledCurrN;

 function selectAnElement(el) {
  currN=el.id;
  if (currN!=null && currN!="" && currN.indexOf("n_")==0)
   evaledCurrN=eval(currN.substr(2));
  if (selectedElements[evaledCurrN]!=evaledCurrN)
   selectedElementsCnt++;
  currElement.className="el_sel";
  //добавил элемент в список выделенных элементов:
  selectedElements[evaledCurrN]=evaledCurrN;
 }

 var el=selectionEnd;
 var selectionBeginN=eval(selectionBegin.id.substr(2));
 var selectionEndN=eval(selectionEnd.id.substr(2));
 var currElement=(selectionBeginN<selectionEndN)?selectionBegin:el;
 var endElement=(selectionBeginN<selectionEndN)?el:selectionBegin;
 while (currElement &&
        (!currElement.previousSibling ||
         (currElement.previousSibling && currElement.previousSibling!=endElement)
        )
       ) {
  if (currElement.nodeName=="DIV" && currElement.className.indexOf("el_")==0)
   selectAnElement(currElement);
  currElement=currElement.nextSibling;
 }
}

function scrollingTimer() {
 var tmpEl,el,n,r,l,elemListHeight;
 el=document.getElementById("elementList");
 if (scrolling=="up") {
  document.getElementById("elementList").scrollTop-=40;
  lft=0;
  rgt=el.children.length-1;
  while (lft<rgt) {
   n=Math.round((lft+rgt-1)/2);
   tmpEl=el.children[n];
   r=tmpEl.getBoundingClientRect();
   if (!r) {alert("r==null N1");return false;}
   if (r.top<0 && r.bottom<0) lft=n+1;
   else if (r.top>0 && r.bottom>0) rgt=n;
   else if (r.top==0 || (r.top<0 && r.bottom>=0)) {lft=n; rgt=n;}
   firstTime=false;
  }
  selectElements(activeElement,el.children[lft]);
  removeActivityFromActiveElement();
  activeElement=el.children[lft];
  setActivityToElement(activeElement);
  //r=el.children[lft].getBoundingClientRect();
  //document.getElementById("elementList").scrollTop-=r.top;
 }
 if (scrolling=="down") {
  document.getElementById("elementList").scrollTop+=40;
  lft=0;
  rgt=el.children.length-1;
  elemListHeight=el.offsetHeight-scrollbarHeight;
  while (lft<rgt) {
   n=Math.round((lft+rgt-1)/2);
   tmpEl=el.children[n];
   r=tmpEl.getBoundingClientRect();
   if (!r) {alert("r==null N2"); return false;}
   if (r.top<elemListHeight && r.bottom<elemListHeight) lft=n+1;
   else if (r.top>elemListHeight && r.bottom>elemListHeight) rgt=n;
   else if (r.bottom==elemListHeight || (r.top<=elemListHeight && r.bottom>elemListHeight)) {lft=n; rgt=n;}
   firstTime=false;
  }
  //alert(el.children[lft].outerHTML);
  selectElements(activeElement,el.children[lft]);
  removeActivityFromActiveElement();
  activeElement=el.children[lft];
  setActivityToElement(activeElement);
 }
 parent.frame3.document.getElementById("selectedInput").value=selectedElementsCnt.toString();
}

function myOnClick() {
 var el=event.srcElement;
 while (el && el.nodeName!="BODY" && el.nodeName!="DIV" || (el.nodeName=="DIV" && el.className!=null && el.className!="" &&
        el.className.search("el_")!=0))
  el=el.parentNode;
 if (!el || el.nodeName!="DIV" || el.className.search("el_")!=0) { event.returnValue=true; return true; }
  //теперь в el элемент, по которому кликнул пользователь
 var rng=mainDoc.body.createTextRange();
 var myN=el.id;
 var evaledN=null;
 if (myN==null || myN=="" || myN.indexOf("n_")!=0) return;
 evaledN=eval(myN.substr(2));
 if ((currentElementType=="titles" || currentElementType=="subtitles" ||
      currentElementType=="emphasis" || currentElementType=="strong" ||
      currentElementType=="sup" || currentElementType=="sub" ||
      currentElementType=="strikethrough") && evaledN) {
  try {
   mainWin.scroll(0,0);
   rng.moveToElementText(myLinks[evaledN]);
   mainWin.scrollBy(0,rng.boundingTop-80);
   rng.select();
   var winHeight=document.documentElement.clientHeight;
   /*alert("rng.boundingTop: "+rng.boundingTop+"    winHeight: "+winHeight);
   if (rng.boundingHeight<=winHeight)
    mainWin.scroll(0,Math.floor(rng.boundingTop-winHeight/2));
   else
    mainWin.scrollBy(0,rng.boundingTop);*/
  }
  catch(e) {
   alert("При установке фокуса видимости на элемент произошла ошибка.");
  }
 }
 //обработка выделения с незажатым шифтом и незажатым контролом
 if (!event.ctrlKey && !event.shiftKey) {
  //чистка списка выделенных элементов
  for (k in selectedElements)
   if (selectedElements[k]==k)
    document.getElementById("n_"+k).className="el_";
  selectedElements={};
  selectedElementsCnt=0;
 }
 //если клик сделан с контролом, уберем стиль активности с активного элемента
 if (event.ctrlKey)
  removeActivityFromActiveElement();
 if (event.shiftKey) {
  //чистка списка выделенных элементов
  if (!event.ctrlKey) {
   for (k in selectedElements)
    if (selectedElements[k]==k)
     document.getElementById("n_"+k).className="el_";
   selectedElements={};
   selectedElementsCnt=0;
  }
 }
 //обработка выделения с зажатым шифтом и незажатым контролом)
 if (event.shiftKey && evaledN && selectionBegin) {
  var oldN=selectionBegin.id;
  if (oldN==null || oldN=="" || oldN.indexOf("n_")!=0) return;
  evaledOldN=eval(oldN.substr(2));
  if (!event.ctrlKey) {
   //alert("добавляем в список n_"+evaledOldN);
   selectedElements[evaledOldN]=evaledOldN;
   selectionBegin.className="el_sel";
   selectedElementsCnt=1;
  }
  if (evaledOldN!=evaledN) {
   selectElements(selectionBegin,el);
  }
 }

 //обработка выделения с зажатым контролом
 if (event.ctrlKey) {
  if (el.className=="el_") {
   if (selectedElements[evaledN]!=evaledN) {
    selectedElements[evaledN]=evaledN;
    selectedElementsCnt++;
   }
   el.className="el_active_sel";
  } else if (el.className=="el_sel" || el.className=="el_active_sel") {
   selectedElements[evaledN]=undefined;
   selectedElementsCnt--;
   el.className="el_active";
  }
 }

 if (!event.ctrlKey || (event.ctrlKey && event.shiftKey)) {
  el.className="el_active_sel";
  if (selectedElements[evaledN]!=evaledN) {
   selectedElements[evaledN]=evaledN;
   selectedElementsCnt++;
  }
 }

 activeElement=el;
 if (!event.shiftKey)
  selectionBegin=el;
 if (!event.ctrlKey && !event.shiftKey) {
  //занесем в список выделенных элементов элемент, по которому был клик
  if (evaledN) {
   selectedElements[evaledN]=evaledN;
   selectedElementsCnt=1;
  }
 }
 parent.frame3.document.getElementById("selectedInput").value=selectedElementsCnt.toString();
 event.returnValue=false;
 return false;
}

function replaceWithUpperCase(full_match, brackets1, offset_of_match,
                          string_we_search_in) {
 return full_match.toUpperCase();
}

function changeCaseInOneP(pToProcess,howToChange) {
 var el=pToProcess.firstChild;
 var madeLetterBig=false;
 var s1,s2;
 while (el && el!=pToProcess) {
  if (el.nodeType==3) {
   s1=el.nodeValue;
   if (caseFlag=="allSmall" || caseFlag=="onlyFirstBig") s2=s1.toLowerCase();
   if (caseFlag=="allBig") s2=s1.toUpperCase();
   if (caseFlag=="onlyFirstBig" && !madeLetterBig) {
    s2=s2.replace(letterRE,replaceWithUpperCase);
    madeLetterBig=true;
   }
   if (s2!=s1) el.nodeValue=s2;
  }
  if (el.firstChild)
   el=el.firstChild;
  else {
   while (el && el!=pToProcess && el.nextSibling==null) el=el.parentNode;
   if (el && el!=pToProcess) el=el.nextSibling;
  }
 }
}

function changeCase(direction) {
 var i;
 caseFlag=direction;
 sortElements();
 mainWin.external.BeginUndoUnit(mainDoc,"смена регистра абзацев");
 var len=sortedElementArray.length;
 for (i=0; i<len; i++) {
  changeCaseInOneP(myLinks[sortedElementArray[i]]);
  s1=getElementText(myLinks[sortedElementArray[i]]);
  document.getElementById("n_"+sortedElementArray[i]).innerHTML="<P>"+s1+"</P>";
 }
 mainWin.external.EndUndoUnit(mainDoc);
 alert("Выполнено.");
}

function contextMenu() {
 var p=window.createPopup();
 p.document.body.style.height="100%";
 p.document.body.style.margin="0";
 p.document.body.style.padding="0";
 p.document.body.innerHTML=
  "<div style='height:100%; border:1px inset black; background-color:white; font-family:tahoma; font-size:13px; margin:0;'>"+
   "<div onmouseover='this.style.backgroundColor=\"yellow\";' onmouseout='this.style.backgroundColor=\"white\";' onclick='parent.changeCase(\"onlyFirstBig\");' style='width:100%; padding:2px; margin:0;'>"+
    "<p style='padding:0; margin:0;'>Первая буква большая, потом маленькие</p>"+
   "</div>"+
   "<div onmouseover='this.style.backgroundColor=\"yellow\";' onmouseout='this.style.backgroundColor=\"white\";' onclick='parent.changeCase(\"allBig\");' style='width:100%; padding:2px; margin:0;'>"+
    "<p style='padding:0; margin:0;'>Все буквы большие</p>"+
   "</div>"+
   "<div onmouseover='this.style.backgroundColor=\"yellow\";' onmouseout='this.style.backgroundColor=\"white\";' onclick='parent.changeCase(\"allSmall\");' style='width:100%; padding:2px; margin:0;'>"+
    "<p style='padding:0; margin:0;'>Все буквы маленькие</p>"+
   "</div>"+
  "</div>";
 p.show(event.screenX, event.screenY, 290, 80);
}

function myOnMouseDown() {
 if (event.button==1 &&
     event.y>0 && event.y<document.getElementById("elementList").offsetHeight-scrollbarHeight &&
     event.x>0 && event.x<document.getElementById("elementList").offsetWidth-scrollbarWidth) {
  mouseDown=true;
  myOnClick();
  document.getElementById("mouseCaptureSpan").setCapture(true);
  event.returnValue=false;
  return false;
 } else if (event.button==2) {
  if (currentElementType=="titles" || currentElementType=="subtitles") contextMenu();
 } else {
  event.returnValue=true;
  return true;
 }
}

function capturedMouse() {
 el=event.srcElement;
 if (event.type=="mouseover") {
  if (el.nodeName=="BODY") {
   scrolling="no";
   if (mouseTimer!=null) {
    clearInterval(mouseTimer);
    mouseTimer=null;
   }
  }
  while (el && el.nodeName!="BODY" && el.nodeName!="DIV" || (el.nodeName=="DIV" && el.className!=null && el.className!="" &&
         el.className.indexOf("el_")!=0))
   el=el.parentNode;
  if (!el || el.nodeName!="DIV" || el.className.indexOf("el_")!=0) return;
  if (el && el.nodeName=="DIV" && el.className.indexOf("el_")==0) {
   evaledN=eval(el.id.substr(2));
   removeActivityFromActiveElement();
   selectElements(activeElement,el);
   activeElement=el;
   setActivityToElement(activeElement);
   parent.frame3.document.getElementById("selectedInput").value=selectedElementsCnt.toString();
  }
  return true;
 }
 if (event.type=="mouseup") {
  document.getElementById("mouseCaptureSpan").releaseCapture();
  if (mouseTimer!=null) {
   clearInterval(mouseTimer);
   mouseTimer=null;
  }
  scrolling="no";
  return true;
 }
 if (event.type=="mousemove") {
  if (event.y<3) {
   scrolling="up";
   if (mouseTimer==null) mouseTimer=setInterval("scrollingTimer();",100);
  }
  else if (event.y>document.getElementById("elementList").offsetHeight-scrollbarHeight) {
   scrolling="down";
   if (mouseTimer==null) mouseTimer=setInterval("scrollingTimer();",100);
  } else if (mouseTimer!=null) {
   clearInterval(mouseTimer);
   mouseTimer=null;
  }
 }
 return true;
}

function parentIsSectionOrPoemOrStanza(uuu) {
 ptr3=uuu;
 while (ptr3 && ptr3.nodeName!="BODY" &&
        !(ptr3.nodeName=="DIV" && (ptr3.className=="poem" || ptr3.className=="section")))
  ptr3=ptr3.parentNode;
 if (ptr3 && ptr3.nodeName!="BODY") return true;
 return false;
}

function getElementText(ptr) {
 sForText=ptr.innerText.replace(re2,re2_);
 if (sForText.search(onlySpacesRegExp)>=0) sForText=" ";
 if (sForText.search(re0)>=0)
  sForText=sForText.replace(re0,re0_)+"...";
 return sForText;
}

function findBlockElements(ptr,insideSection) {
 ptr=ptr.firstChild;
 if (!ptr) return;
 while (ptr!=null) {
  if (ptr.nodeType==1)
   if (ptr.nodeName!="P") {
    if (currentElementType=="titles" && ptr.nodeName=="DIV" && ptr.className=="title" &&
        parentIsSectionOrPoemOrStanza(ptr) && ptr.parentNode.firstChild==ptr && insideSection){
     ptr2=ptr.firstChild;
     while (ptr2!=null) {
      if (ptr2.nodeName=="P") {
       s1=getElementText(ptr2);
       htmlStr+="<DIV class=el_ id=n_"+nCnt+"><P>"+s1+"</P></DIV>";
       elementsInAll++;
       myLinks[nCnt]=ptr2;
       nCnt++;
      }
      ptr2=ptr2.nextSibling;
     }
     htmlStr+="<DIV class=delim></DIV>";
    } else findBlockElements(ptr,(insideSection || (ptr.nodeName=="DIV" && ptr.className=="section")));
   }
  ptr=ptr.nextSibling;
 }
}

function findParagraphElements(ptr,insideSection) {
 ptr=ptr.firstChild;
 var needGoNext;
 if (!ptr) return;
 while (ptr!=null) {
  needGoNext=true;
  if (ptr.nodeType==1)
   if (ptr.nodeName!="P")
    findParagraphElements(ptr,(insideSection || (ptr.nodeName=="DIV" && ptr.className=="section")));
   else {
    if (currentElementType=="subtitles" && ptr.className=="subtitle"
        && insideSection) {
     while (ptr!=null && currentElementType=="subtitles" && ptr.className=="subtitle") {
      s1=getElementText(ptr);
      htmlStr+="<DIV class=el_ id=n_"+nCnt+"><P>"+s1+"</P></DIV>";
      elementsInAll++;
      myLinks[nCnt]=ptr;
      nCnt++;
      ptr=ptr.nextSibling;
      needGoNext=false;
     }
     htmlStr+="<DIV class=delim></DIV>";
    }
   }
  if (needGoNext) ptr=ptr.nextSibling;
 }
}

function findInlineElements(ptr,insideSection,elemNameRE) {
 if (ptr.nodeName=="P") foundInlineElementsInP=false;
 ptr=ptr.firstChild;
 //alert("вход. ptr:\n\n"+ptr.outerHTML);
 var needGoNext;
 if (!ptr) return;
 while (ptr!=null) {
  needGoNext=true;
  if (ptr.nodeType==1) {
    if (insideSection && ptr.nodeName.search(elemNameRE)>=0) {
     //while (ptr!=null && ptr.nodeName.search(elemNameRE)>=0) {
      s1=getElementText(ptr);
      htmlStr+="<DIV class=el_ id=n_"+nCnt+"><P>"+s1+"</P></DIV>";
      elementsInAll++;
      myLinks[nCnt]=ptr;
      nCnt++;
      needGoNext=false;
      foundInlineElementsInP=true;
     //}
    }
   //alert("перед findInlineElements. ptr:\n\n"+ptr.outerHTML);
   findInlineElements(ptr,(insideSection || (ptr.nodeName=="DIV" && ptr.className=="section")),elemNameRE);
   if (ptr.nodeName=="P" && foundInlineElementsInP) htmlStr+="<DIV class=delim></DIV>";
  }
  ptr=ptr.nextSibling;
 }
}

function InflateIt(elem) {
 if (!elem || elem.nodeType!=1) return;
 if (elem.tagName=="P") {
  mainWin.external.inflateBlock(elem)=true;
  return;
 }
 elem=elem.firstChild;
 while (elem) {
  InflateIt(elem);
  elem=elem.nextSibling;
 }
}

function getSectionOrPoemOrStanzaByElement(el) {
 ptr4=el;
 while (ptr4 && ptr4.nodeName!="BODY" &&
        !(ptr4.nodeName=="DIV" && (ptr4.className=="section" || ptr4.className=="stanza" || ptr4.className=="poem")))
  ptr4=ptr4.parentNode;
 if (!ptr4 || ptr4.nodeName=="BODY") return null;
 return ptr4;
}

function getSectionByElement(el) {
 ptr4=el;
 while (ptr4 && ptr4.nodeName!="BODY" &&
        !(ptr4.nodeName=="DIV" && ptr4.className=="section"))
  ptr4=ptr4.parentNode;
 if (!ptr4 || ptr4.nodeName=="BODY") return null;
 return ptr4;
}

function prevNotSection(ff) {
 if (ff.id=="fbw_body") return false;
 if (ff.previousSibling==null || ff.nodeName!="DIV" || ff.className!="section") return true;
 return false;
}

function isSection(gg) {
 if (!gg) return false;
 if (gg.nodeName!="DIV" || gg.className!="section") return false;
 return true;
}

function moveBlockIntoPreviousBlock() {
 //alert("moveBlockIntoPreviousBlock\n\n"+"sectionOrPoemOrStanza:\n\n"+sectionOrPoemOrStanza.outerHTML);
 killPrev=false;
 tt=sectionOrPoemOrStanza.firstChild;
 if (sectionOrPoemOrStanza.className=="section") {
  el9=sectionOrPoemOrStanza;
  while (prevNotSection(el9))
   el9=el9.parentNode;
  //alert("el9.outerHTML:\n\n"+el9.outerHTML);
  if (el9.id=="fbw_body") return;
  if (isSection(el9.previousSibling)) {
   prevSectionOrPoemOrStanza=el9.previousSibling;
  }
  else
   if (el9!=sectionOrPoemOrStanza) {
    newSection=mainDoc.createElement("DIV");
    newSection.className="section";
    prevSectionOrPoemOrStanza=el9.insertAdjacentElement("afterBegin",newSection);
   } else {
    newSection=mainDoc.createElement("DIV");
    newSection.className="section";
    prevSectionOrPoemOrStanza=sectionOrPoemOrStanza.insertAdjacentElement("beforeBegin",newSection);
    if (prevSectionOrPoemOrStanza.parentNode.nodeName!="DIV" ||
        prevSectionOrPoemOrStanza.parentNode.className!="body")
     killPrev=true;
   }
 } else prevSectionOrPoemOrStanza=sectionOrPoemOrStanza.previousSibling;
 //alert(prevSectionOrPoemOrStanza.outerHTML);
 if (!prevSectionOrPoemOrStanza || prevSectionOrPoemOrStanza.nodeName!="DIV" ||
     prevSectionOrPoemOrStanza.className!=sectionOrPoemOrStanza.className) {
  //alert("Ошибка. Код ошибки: 82bc82nc7.\n\n"+
  //      "sectionOrPoemOrStanza:\n\n"+sectionOrPoemOrStanza.outerHTML.substr(0,50)+"\n\n"+
  //      "prevSectionOrPoemOrStanza\n\n"+prevSectionOrPoemOrStanza.outerHTML.substr(0,50)+"\n\n");
  return;
 }
 if (sectionOrPoemOrStanza.className=="section")
  while (prevSectionOrPoemOrStanza.lastChild && prevSectionOrPoemOrStanza.lastChild.nodeName=="DIV" &&
         prevSectionOrPoemOrStanza.lastChild.className=="section")
   prevSectionOrPoemOrStanza=prevSectionOrPoemOrStanza.lastChild;
 if (flag3) {
  //alert("flag3");
  newSection=mainDoc.createElement("DIV");
  newSection.className="section";
  prevSectionOrPoemOrStanza=prevSectionOrPoemOrStanza.insertAdjacentElement("beforeEnd",newSection);
 }
 while (tt && !isSection(tt)) {
  nextTt=tt.nextSibling;
  prevSectionOrPoemOrStanza.insertAdjacentElement("beforeEnd",tt.removeNode(true));
  tt=nextTt;
 }
 if (!tt) {
  tt=sectionOrPoemOrStanza.parentNode;
  sectionOrPoemOrStanza.removeNode(true);
  while (isSection(tt) && tt.firstChild==null) {
   nextTt=tt.parentNode;
   tt.removeNode(true);
   tt=nextTt;
  }
 } else sectionOrPoemOrStanza.removeNode(false);
 if (killPrev) prevSectionOrPoemOrStanza.removeNode(false);
 //alert("moveBlockIntoPreviousBlock: exit.");
}

/*function moveBlockIntoPreviousBlock() {
 //функция принимает параметр в глобальной переменной sectionOrPoemOrStanza
 prevSectionOrPoemOrStanza=sectionOrPoemOrStanza.previousSibling;
 if (!prevSectionOrPoemOrStanza || prevSectionOrPoemOrStanza.nodeName!="DIV" ||
     prevSectionOrPoemOrStanza.className!=sectionOrPoemOrStanza.className) {
  //alert("Ошибка. Код ошибки: 82bc82nc7.\n\n"+
  //      "sectionOrPoemOrStanza:\n\n"+sectionOrPoemOrStanza.outerHTML.substr(0,50)+"\n\n"+
  //      "prevSectionOrPoemOrStanza\n\n"+prevSectionOrPoemOrStanza.outerHTML.substr(0,50)+"\n\n");
  return;
 }
 if (sectionOrPoemOrStanza.className=="section" || sectionOrPoemOrStanza.className=="poem") {
  elemInList=document.getElementById("n_"+sortedElementArray[nPtr-1]);
  while (true) {
   elemInList=elemInList.nextSibling;
   if (!elemInList) break;
   if (elemInList.className=="delim") continue;
   if (!elemInList.id || elemInList.id=="") break;
   elemInMainDoc2=myLinks[eval(elemInList.id.substr(2))];
   parentSectionOrPoemOrStanza_of_elemInMainDoc=getSectionOrPoemOrStanzaByElement(elemInMainDoc2);
   if (!elemInList.className) continue;
   isElement=elemInList.className.indexOf("el_")==0;
   if (!(
         (isElement &&
          parentSectionOrPoemOrStanza_of_elemInMainDoc.className.search(poemOrStanzaRegexp)>=0 &&
          getSectionByElement(parentSectionOrPoemOrStanza_of_elemInMainDoc)==getSectionByElement(sectionOrPoemOrStanza)
         )
         || !isElement
        )
      ) break;
   //пометим атрибутом sv те абзацы, на которые есть ссылки в списке,
   //чтобы обновить ссылки после перемещения абзацев
   elemInMainDoc2.setAttribute("sv",elemInList.id.substr(2));
  }
 }
 prevSectionOrPoemOrStanza.insertAdjacentHTML("beforeEnd","<SPAN id='"+randomId+"'></SPAN>"+sectionOrPoemOrStanza.innerHTML);
 marker=mainDoc.getElementById(randomId);
 el2=marker;
 if (el2) {
  while (el2!=prevSectionOrPoemOrStanza) {
   if (el2.nodeName=="P") {
    mainWin.external.inflateBlock(el2)=true;
    attributeSv=el2.getAttribute("sv");
    if (attributeSv) {
     myLinks[eval(attributeSv)]=el2;
     el2.removeAttribute("sv");
    }
   }
   if (el2.nodeName=="DIV" && el2.className=="epigraph" && el2.previousSibling &&
       !(el2.previousSibling.nodeName=="DIV" && el2.previousSibling.className=="title")) {
    saveEl2=el2;
    el2=getNextEl2(el2,null);
    saveEl2.removeNode(false);
   }
   if (el2.firstChild && el2.nodeName!="P")
    el2=el2.firstChild;
   else {
    while (el2!=prevSectionOrPoemOrStanza && el2.nextSibling==null) el2=el2.parentNode;
    if (el2!=prevSectionOrPoemOrStanza) el2=el2.nextSibling;
   }
  }
  marker.removeNode(true);
 }
 marker=mainDoc.getElementById(randomId);
 el2=marker;
 if (el2) {
  while (el2!=prevSectionOrPoemOrStanza) {
   if (el2.nodeName=="P") mainWin.external.inflateBlock(el2)=true;
   if (el2.firstChild && el2.nodeName!="P")
    el2=el2.firstChild;
   else {
    while (el2!=prevSectionOrPoemOrStanza && el2.nextSibling==null) el2=el2.parentNode;
    if (el2!=prevSectionOrPoemOrStanza) el2=el2.nextSibling;
   }
  }
  marker.removeNode(true);
 }
 sectionOrPoemOrStanza.removeNode(true);
}*/

function undo() {
 mainDoc.execCommand('undo');
 selectChange(currentElementType);
}

function redo() {
 mainDoc.execCommand('redo');
 selectChange(currentElementType);
}

function selectAllElements() {
 var n;
 var pp=document.getElementById("elementList");
 if (!pp) {alert("Ошибка. Код ошибки ch26cb27db."); return;}
 pp=pp.firstChild;
 if (!pp) return;
 while (pp) {
  if (pp.nodeName=="DIV" && pp.className.indexOf("el_")==0 && pp.className.indexOf("sel")<0) {
   n=eval(pp.id.substr(2));
   selectedElements[n]=n;
   selectedElementsCnt++;
   if (pp.className=="el_") pp.className="el_sel";
   else if (pp.className=="el_active") pp.className="el_active_sel";
  }
  pp=pp.nextSibling;
 }
 parent.frame3.document.getElementById("selectedInput").value=selectedElementsCnt.toString();
}

function myOnKeydown() {
 if (event.keyCode=="65" && event.ctrlKey) {
  selectAllElements();
  return false;
 }
 return true;
}

function sortElements() {

 var k,cnt=0;
 sortedElementArray=[];
 for (k in selectedElements)
  if (selectedElements[k]==k) {
   sortedElementArray[cnt]=k;
   cnt++;
  }
 sortedElementArray=sortedElementArray.sort(function(a,b) { return a-b; });
}

function selectChange(whatSelected) {
 var fbwBody=window.dialogArguments["fbwBody"];
 var elementList=document.getElementById("elementList");
 currentElementType=whatSelected;
 htmlStr="";
 insideSection=false;
 selectedElements={};
 activeElement=null;
 elementsInAll=0;
 selectedElementsCnt=0;
 selectionBegin=null;
 nCnt=1;
 if (currentElementType=="titles") findBlockElements(fbwBody,false);
 else if (currentElementType=="subtitles") findParagraphElements(fbwBody,false);
 else if (currentElementType=="emphasis") findInlineElements(fbwBody,false,/^(EM|I)$/i);
 else if (currentElementType=="strong") findInlineElements(fbwBody,false,/^(B|STRONG)$/i);
 else if (currentElementType=="sup") findInlineElements(fbwBody,false,/^(SUP)$/i);
 else if (currentElementType=="sub") findInlineElements(fbwBody,false,/^(SUB)$/i);
 else if (currentElementType=="strikethrough") findInlineElements(fbwBody,false,/^(STRIKE)$/i);
 elementList.innerHTML=htmlStr;
 parent.frame3.document.getElementById("inAllInput").value=elementsInAll.toString();
 var el=parent.frame3.document.getElementById("reformatTo_select");
 var val=el.value;
 if (currentElementType=="titles") {
  el.outerHTML=
   "<SELECT id=reformatTo_select>"+
   "<OPTION value=subtitles selected>subtitles</OPTION>"+
   "<OPTION value=text>text</OPTION></SELECT>";
  if (val=="text") parent.frame3.document.getElementById("reformatTo_select").value=val;
 } else if (currentElementType=="subtitles") {
  el.outerHTML=
   "<SELECT id=reformatTo_select>"+
   "<OPTION value=titles selected>titles</OPTION>"+
   "<OPTION value=text>text</OPTION></SELECT>";
   if (val=="text") parent.frame3.document.getElementById("reformatTo_select").value=val;
 } else if (currentElementType=="subtitles" || currentElementType=="emphasis" ||
            currentElementType=="strong" || currentElementType=="sup" ||
            currentElementType=="sub" || currentElementType=="strikethrough") {
  el.outerHTML=("<SELECT id=reformatTo_select>"+
   "<OPTION value=text>text</OPTION>"+
   "<OPTION value=emphasis>emphasis</OPTION>"+
   "<OPTION value=strong>strong</OPTION>"+
   "<OPTION value=sup>sup</OPTION>"+
   "<OPTION value=sub>sub</OPTION>"+
   "<OPTION value=strikethrough>strikethrough</OPTION></SELECT>").replace(new RegExp("<OPTION value="+currentElementType+">"+currentElementType+"</OPTION>","i"),"")/*.replace(/(value=[a-z]+?)(>)/i,"$1 selected$2")*/;
  if ((val=="subtitles" || val=="emphasis" || val=="strong" || val=="sup" || val=="sub" ||
      val=="strikethrough") && val!=currentElementType)
   parent.frame3.document.getElementById("reformatTo_select").value=val;
 }
}

function removeReformattedElementsFromList() {
 nPtr=0;
 while (nPtr<sortedElementArray.length) {
  kkEl=document.getElementById("n_"+sortedElementArray[nPtr]);
  if (!kkEl) {alert("Ошибка. Код ошибки mv74hf7b7."); return;}
  ttEl=kkEl;
  if (kkEl.getAttribute("NoDel")!=null) {
   kkEl.removeAttribute("NoDel");
   nPtr++;
   continue;
  }
  //проверим элемент перед текущим
  if (kkEl.previousSibling==null ||
      (kkEl.previousSibling && kkEl.previousSibling.nodeName=="DIV" && kkEl.previousSibling.className=="delim"))
   needKillDelim=true;
  else
   needKillDelim=false;
  //пройдемся вперед по элементам, которые нужно удалить
  while (kkEl.nextSibling && kkEl.nextSibling.nodeName=="DIV" && kkEl.nextSibling.className.indexOf("el_")==0 &&
         selectedElements[eval(kkEl.nextSibling.id.substr(2))]==kkEl.nextSibling.id.substr(2) &&
         kkEl.nextSibling.getAttribute("NoDel")==null) {
   nPtr++;
   kkEl=kkEl.nextSibling;
  }
  //удалим элементы
  while (ttEl!=kkEl) {
   ttEl=ttEl.nextSibling;
   selectedElements[eval(ttEl.previousSibling.id.substr(2))]=undefined;
   ttEl.previousSibling.removeNode(true);
   selectedElementsCnt--;
   elementsInAll--;
  }
  if (ttEl && ttEl.nextSibling.nodeName=="DIV" && ttEl.nextSibling.className=="delim")
    { if (needKillDelim) ttEl.nextSibling.removeNode(true); }
  else if (!needKillDelim)
   ttEl.insertAdjacentHTML("afterEnd","<DIV class=delim></DIV>");
  ttEl.removeNode(true);
  selectedElements[eval(ttEl.id.substr(2))]=undefined;
  selectedElementsCnt--;
  elementsInAll--;
  nPtr++;
 }
}

function reformatSubtitlesToText() {
 sortElements();
 var myElem5,newStanza;
 for (nPtr=0;nPtr<sortedElementArray.length;nPtr++) {
  //запишем в myElem5 ссылку на абзац-подзаголовок, который нужно сконвертировать
  myElem5=myLinks[sortedElementArray[nPtr]];
  myElem5.removeAttribute("className");
  myElem5.removeAttribute("class");
  if (getSectionOrPoemOrStanzaByElement(myElem5).className=="poem") {
   newStanza=mainDoc.createElement("DIV");
   newStanza.className="stanza";
   myElem5.applyElement(newStanza,"outside");
  }
 }
 removeReformattedElementsFromList();
}

function reformatInlineToInlineOrText(reformatToWhat) {
 sortElements();
 var myElem7,myElem8,el,nextEl;
 for (nPtr=0;nPtr<sortedElementArray.length;nPtr++) {
  //запишем в myElem5 ссылку на абзац-подзаголовок, который нужно сконвертировать
  myElem6=myLinks[sortedElementArray[nPtr]];
  if (reformatToWhat!="text") {
   myElem8=mainDoc.createElement(htmlTagByFb2Tag[reformatToWhat]);
   myElem6.applyElement(myElem8,"outside");
  }
  myElem6.removeNode(false);
  if (reformatToWhat=="text") continue;  
  el=myElem8.firstChild;
  while (el && el!=myElem8) {
   nextEl=el;
   if (nextEl.firstChild)
    nextEl=nextEl.firstChild;
   else {
    while (nextEl!=myElem8 && nextEl.nextSibling==null) nextEl=nextEl.parentNode;
    if (nextEl!=myElem8) nextEl=nextEl.nextSibling;
   }
   if (el.nodeName.search(htmlTagRegExpByFb2Tag[reformatToWhat])>=0) el.removeNode(false);
   el=nextEl;
  }
  el=myElem8;
  while (el.nodeName!="BODY") {
   el=el.parentNode;
   if (el.nodeName.search(htmlTagRegExpByFb2Tag[reformatToWhat])>=0) {
    myElem8.removeNode(false);
    break;
   }
  }
 }
 removeReformattedElementsFromList();
}

function getNextEl2(rrr,lll) {
 var ddd=rrr;
 if (ddd.firstChild && ddd.nodeName!="P")
  ddd=ddd.firstChild;
 else {
  while (ddd!=prevSectionOrPoemOrStanza && ddd.nextSibling==null && ddd!=lll) ddd=ddd.parentNode;
  if (ddd!=prevSectionOrPoemOrStanza && ddd!=markerEnd) ddd=ddd.nextSibling;
 }
 return ddd;
}

function reformatSubtitlesToTitles() {

 function setPrevSectionOrPoemOrStanza() {
  prevSectionOrPoemOrStanza=sectionOrPoemOrStanza.previousSibling;
  if (!prevSectionOrPoemOrStanza || prevSectionOrPoemOrStanza.className!=sectionOrPoemOrStanza.className ||
      (sectionOrPoemOrStanza.firstChild.nodeName=="DIV" || sectionOrPoemOrStanza.firstChild.className=="title")) {
   prevSectionOrPoemOrStanza=mainDoc.createElement("DIV");
   prevSectionOrPoemOrStanza.className=sectionOrPoemOrStanza.className;
   sectionOrPoemOrStanza.insertAdjacentElement("beforeBegin",prevSectionOrPoemOrStanza);
  }
 }

 function setNextSectionOrPoemOrStanza() {
  nextSectionOrPoemOrStanza=sectionOrPoemOrStanza.nextSibling;
  if (!nextSectionOrPoemOrStanza || nextSectionOrPoemOrStanza.nodeName!="DIV" ||
      nextSectionOrPoemOrStanza.className!=sectionOrPoemOrStanza.className) {
   nextSectionOrPoemOrStanza=mainDoc.createElement("DIV");
   nextSectionOrPoemOrStanza.className=sectionOrPoemOrStanza.className;
   newP=nextSectionOrPoemOrStanza.insertAdjacentElement("beforeEnd",mainDoc.createElement("P"));
   mainWin.external.inflateBlock(newP)=true;
   sectionOrPoemOrStanza.insertAdjacentElement("afterEnd",nextSectionOrPoemOrStanza);
  }
 }

 var myEl,parentSection,thereWasSubtitlesInCite=false;
 sortElements();
 for (var nPtr=0;nPtr<sortedElementArray.length;nPtr++) {
  elemInMainDoc=myLinks[sortedElementArray[nPtr]];
  if (elemInMainDoc.parentNode.nodeName=="DIV" && elemInMainDoc.parentNode.className=="cite") {
   thereWasSubtitlesInCite=true;
   document.getElementById("n_"+sortedElementArray[nPtr]).setAttribute("NoDel","");
   continue;
  }
  if (!elemInMainDoc) {alert("Ошибка. Код ошибки 26cb37cn3."); return;}
  sectionOrPoemOrStanza=getSectionOrPoemOrStanzaByElement(elemInMainDoc);
  if (!sectionOrPoemOrStanza) {alert("Ошибка. Код ошибки xhc83nx38."); return;}
  //перенесем содержимое секции от начала до текущего подзаголовка - в секцию перед текущей
  myEl=sectionOrPoemOrStanza.firstChild;
  if (!myEl) {alert("Ошибка. Код ошибки 9c7c32n27."); return;}
  htmlStr="";
  if (elemInMainDoc.previousSibling && !(elemInMainDoc.previousSibling.nodeName=="DIV" && elemInMainDoc.previousSibling.className=="title")) {
   setPrevSectionOrPoemOrStanza();
   while (myEl && myEl!=elemInMainDoc) {
    //перенесем содержимое-не подзаголовки
    saveNext=myEl.nextSibling;
    prevSectionOrPoemOrStanza.insertAdjacentElement("beforeEnd",myEl);
    myEl=saveNext;
   }
  }
  //превратим подзаголовок в заголовок
  if (!(elemInMainDoc.previousSibling && elemInMainDoc.previousSibling.nodeName=="DIV" &&
        elemInMainDoc.previousSibling.className=="title")
     ) {
   titleElement=mainDoc.createElement("DIV");
   titleElement.className="title";
   titleElement=elemInMainDoc.parentNode.insertAdjacentElement("afterBegin",titleElement);
  } else
   titleElement=elemInMainDoc.previousSibling;
  if (!titleElement) {alert("Ошибка. Код ошибки 73db37d36."); return;}
  elemInMainDoc.removeAttribute("className");
  elemInMainDoc.removeAttribute("class");
  titleElement.insertAdjacentElement("beforeEnd",elemInMainDoc.removeNode(true));
  if (titleElement.parentNode.lastChild==titleElement) {
   //если заголовок получился в конце секции, перенесем его в следующую секцию,
   //возможно присоединив к уже имеющемуся там заголовку
   setNextSectionOrPoemOrStanza();
   if (!nextSectionOrPoemOrStanza.firstChild ||
       nextSectionOrPoemOrStanza.firstChild.nodeName!="DIV" ||
       nextSectionOrPoemOrStanza.firstChild.className!="title") {
    nextSectionOrPoemOrStanza.insertAdjacentElement("afterBegin",titleElement.removeNode(true));
   } else {
    titleInNextSection=nextSectionOrPoemOrStanza.firstChild;
    titleInNextSection.insertAdjacentHTML("afterBegin",titleElement.innerHTML);
    if (titleElement.parentNode.firstChild==titleElement && titleElement.parentNode.lastChild==titleElement)
     titleElement.parentNode.removeNode(true);
    else
     titleElement.removeNode(true);
   }
  }
 } //for (var nPtr=0;nPtr<sortedElementArray.length;nPtr++)
 removeReformattedElementsFromList();
 if (thereWasSubtitlesInCite)
  alert("Среди выделенных подзаголовков были подзаголовки, вложенные в цитаты. Они не были превращены в заголовки в процессе обработки.");
} //reformatSubtitlesToTitles();

function getMatchOfElemInList(el) {
 if (el.id.indexOf("n_")!=0) {alert("Ошибка. Код ошибки bvd2jhd28."); return;}
 return myLinks[el.id.substr(2)];
}

function reformatTitlesToSubtitlesOrText() {

 var myEl;

 function prepareMoveIntoPreviousContainer(p) {
  el3=getSectionOrPoemOrStanzaByElement(parentTitle);
  if (!el3) {alert("Ошибка. Код ошибки 7cb37cxb632."); return;}
  previousSection=el3.previousSibling;
  if (previousSection && previousSection.nodeName!="DIV" && previousSection.className!=el3.className)
   previousSection=null;
  myEl=p.cloneNode(true);
  myEl.id=p.id;
  if (currentTargetElementType=="p") { myEl.removeAttribute("class"); myEl.removeAttribute("className"); }
  if (currentTargetElementType=="subtitle") myEl.className="subtitle";
  htmlStr+=myEl.outerHTML;
  p.removeNode(true);
 }

 function finalizeMoveIntoPreviousContainer(flag1) {
  el3=getSectionOrPoemOrStanzaByElement(parentTitle);
  flag2=(el3.className=="poem" && currentTargetElementType=="p");
  if (flag1) {
   flag3=false/*el3.className=="section" && el3.lastChild && el3.lastChild.nodeName=="DIV" && el3.lastChild.className=="section";*/
   parentTitle.insertAdjacentHTML("beforeBegin",
    "<SPAN id='"+randomId+"_begin'></SPAN>"+
    (flag2?"<DIV class=stanza>":"")+
    (flag3?"<DIV class=section>":"")+
    htmlStr+
    (flag2||flag3?"</DIV>":"")+
    "<SPAN id='"+randomId+"_end'></SPAN>");
    el5=parentTitle.nextSibling;
    while (el5 && el5.nodeName=="DIV" && el5.className=="epigraph") {
     saveEl5=el5;
     el5=el5.nextSibling;
     saveEl5.removeNode(false);
    }
  }
  else {
   if (!el3) {alert("Ошибка. Код ошибки 7g3od8c6nm."); return;}
   if (!previousSection || previousSection.nodeName!="DIV" || previousSection.className!=el3.className) {
    newSection=mainDoc.createElement("DIV");
    newSection.className=el3.className;
    previousSection=el3.insertAdjacentElement("beforeBegin",newSection);
   } else {
    while (previousSection.lastChild && previousSection.lastChild.nodeName=="DIV" &&
           previousSection.lastChild.className=="section")
     previousSection=previousSection.lastChild;
   }
   flag2=previousSection.className=="poem";
   previousSection.insertAdjacentHTML("beforeEnd","<SPAN id='"+randomId+"_begin'></SPAN>"+(flag2?"<DIV class=stanza>":"")+htmlStr+(flag2?"</DIV>":"")+"<SPAN id='"+randomId+"_end'></SPAN>");
  }
  //найдем маркер начала вставленного html-кода
  markerBegin=mainDoc.getElementById(randomId+"_begin");
  //найдем маркер конца вставленного html-кода
  markerEnd=mainDoc.getElementById(randomId+"_end");
  if (markerBegin && markerEnd) {
   //получим в el2 элемент, следующий за маркером начала
   el2=markerBegin;
   el2=getNextEl2(el2,markerEnd);
   markerBegin.removeNode(true);
   //пройдемся по вставленному html-коду, делая пустые строки пустыми и удаляя эпиграфы, если надо
   while (el2!=prevSectionOrPoemOrStanza && el2!=markerEnd) {
    if (el2.nodeName=="P") mainWin.external.inflateBlock(el2)=true;
    el2=getNextEl2(el2,markerEnd);
   }
  }
  markerEnd.removeNode(true);
 }

 function getNext(ggg) {
  if (!ggg) {alert("Ошибка. Параметр getNext() равен null."); return;}
  saveNext=ggg;
  if (saveNext.firstChild && saveNext.nodeName!="P")
   saveNext=saveNext.firstChild;
  else {
   while (saveNext!=parentTitle && saveNext.nextSibling==null) {
    saveNext=saveNext.parentNode;
   }
   if (saveNext!=parentTitle)
    saveNext=saveNext.nextSibling;
  }
  while (saveNext!=parentTitle && saveNext.nodeName!="P") {
   if (saveNext.firstChild && saveNext.nodeName!="P")
    saveNext=saveNext.firstChild;
   else {
    while (saveNext!=parentTitle && saveNext.nextSibling==null)
     saveNext=saveNext.parentNode;
    if (saveNext!=parentTitle)
     saveNext=saveNext.nextSibling;
   }
  }
  return saveNext;
 }

 var saveNext;
 var firstElFromCurrentBlock;
 sortElements();
 nPtr=0;
 var parentTitle=null;
 while (nPtr<sortedElementArray.length) {
  firstElFromCurrentBlock=myLinks[sortedElementArray[nPtr]];
  parentTitle=getTitleByElement(firstElFromCurrentBlock);
  if (parentTitle.nodeName=="BODY") {alert("Ошибка!\nКод ошибки: mc93jf7hnf."); return;}
  //alert(parentTitle.outerHTML);

  elemInMainDoc=parentTitle.firstChild;
  //var childsOfParentBlock=[];
  /*while (!(elemInMainDoc.nodeName=="DIV" && elemInMainDoc.className!="title")) {
   childsOfParentBlock.push(elemInMainDoc);*/

  //попытаемся перейти на предыдущий параграф,
  //но не выходя за пределы блочного родителя
  while (elemInMainDoc!=parentTitle && elemInMainDoc.nodeName!="P") {
   if (elemInMainDoc.firstChild)
    elemInMainDoc=elemInMainDoc.firstChild;
   else {
    while (elemInMainDoc!=parentTitle && elemInMainDoc.nextSibling==null)
     elemInMainDoc=elemInMainDoc.parentNode;
    if (elemInMainDoc!=parentTitle)
     elemInMainDoc=elemInMainDoc.nextSibling;
   }
  }

  elemInList=document.getElementById("n_"+sortedElementArray[nPtr]);
  gg=getSectionOrPoemOrStanzaByElement(myLinks[sortedElementArray[nPtr]]);
  while (elemInList.previousSibling &&
         (elemInList.previousSibling.className.indexOf("el_")==0 &&
          getSectionOrPoemOrStanzaByElement(getMatchOfElemInList(elemInList.previousSibling))==gg
         )
        )
   elemInList=elemInList.previousSibling;
  //условие в следующей строке выполняется,
  //если текущий выделенный элемент - первый в блочном родителе
  if (elemInMainDoc==firstElFromCurrentBlock) {
   //ПЕРВАЯ ОБРАБОТКА
   //обработаем выделенные абзацы заголовка в начале блока
   var elemInListMatchInMainDoc;
   var quitByMeetingUnselectedElement=false;
   htmlStr="";
   var firstTime=true;

   //WHILE
   while (elemInMainDoc && nPtr<sortedElementArray.length && elemInMainDoc==myLinks[sortedElementArray[nPtr]]) {
    elemInListMatchInMainDoc=getMatchOfElemInList(elemInList);
    if (getTitleByElement(elemInListMatchInMainDoc)!=parentTitle)
     break;

    if (elemInMainDoc && elemInMainDoc!=parentTitle) {
     //запомним в saveNext следующий элемент P после того, на который указывает elemInMainDoc
     saveNext=getNext(elemInMainDoc);
     prepareMoveIntoPreviousContainer(elemInMainDoc);
     nPtr++;
     elemInList=elemInList.nextSibling;
     //"вспомним" запомненный элемент
     elemInMainDoc=saveNext;
    }
    if (elemInMainDoc!=myLinks[sortedElementArray[nPtr]]) break;
   }
   finalizeMoveIntoPreviousContainer(elemInMainDoc==parentTitle);
   sectionOrPoemOrStanza=getSectionOrPoemOrStanzaByElement(parentTitle);
   if (!parentTitle.firstChild || elemInMainDoc==parentTitle) parentTitle.removeNode(true);
   //если условие верно, нужно перенести остаток секции в предыдущую секцию
   if (!sectionOrPoemOrStanza) {alert("Ошибка!\nКод ошибки g5d8bc5nd."); return;}
  } //if (elemInMainDoc==firstElFromCurrentBlock)
  else {
   elemInMainDoc=getNext(parentTitle);
   sectionOrPoemOrStanza=getSectionOrPoemOrStanzaByElement(parentTitle);
  }

  if (elemInMainDoc==parentTitle) moveBlockIntoPreviousBlock();
  else {
   //ВТОРАЯ ОБРАБОТКА
   //в этой ветке надо обработать невыделенные и выделенные абзацы заголовка,
   //идущие после выделенной группы абзацев в начале заголовка
   while (elemInMainDoc && elemInMainDoc!=parentTitle && nPtr<sortedElementArray.length) {
    elemInListMatchInMainDoc=myLinks[sortedElementArray[nPtr]];
    el4=mainDoc.createElement("DIV");
    el4.className=sectionOrPoemOrStanza.className;
    newTitleElement=mainDoc.createElement("DIV");
    newTitleElement.className="title";
    newTitleElement=el4.appendChild(newTitleElement);
    el4=sectionOrPoemOrStanza.insertAdjacentElement("beforeBegin",el4);
    previousSection=el4;
    if (!el4) {alert("Ошибка. Код ошибки: 7b37cb3h7."); return;}
    //пройдемся по невыделенным абзацам, т.е. по таким, которые нужно оставить заголовками
    while (elemInMainDoc!=parentTitle && elemInMainDoc!=elemInListMatchInMainDoc) {
     unselElemInListMatchInMainDoc=myLinks[eval(elemInList.id.substr(2))];
     if (elemInMainDoc!=unselElemInListMatchInMainDoc) {alert("Ошибка. Код ошибки nv7vhnv383."); return;}
     saveNext=getNext(elemInMainDoc);
     el6=elemInMainDoc.removeNode(true);
     el7=newTitleElement.insertAdjacentElement("beforeEnd",el6);
     //alert("unselElemInListMatchInMainDoc\n\n"+unselElemInListMatchInMainDoc.outerHTML+"\n\n"+
     //      "elemInListMatchInMainDoc:\n\n"+elemInListMatchInMainDoc.outerHTML+"\n\n"+
     //      "el6:\n\n"+el6.outerHTML+"\n\n"+
     //      "eval(elemInList.id.substr(2)): "+eval(elemInList.id.substr(2))+"\n\n"+
     //      "el7:\n\n"+el7.outerHTML);
     myLinks[eval(elemInList.id.substr(2))]=el7;
     elemInMainDoc=saveNext;
     elemInList=elemInList.nextSibling;
     unselElemInListMatchInMainDoc=myLinks[eval(elemInList.id.substr(2))];
    }

    //пройдемся по выделенным абзацам
    htmlStr="";
    while (elemInMainDoc && elemInMainDoc!=parentTitle && nPtr<sortedElementArray.length && elemInMainDoc==myLinks[sortedElementArray[nPtr]]) {
     elemInListMatchInMainDoc=myLinks[sortedElementArray[nPtr]];
     if (getTitleByElement(elemInListMatchInMainDoc)!=parentTitle)
     break;
     if (elemInMainDoc && elemInMainDoc!=parentTitle) {
      //запомним в saveNext следующий элемент P после того, на который указывает elemInMainDoc
      saveNext=getNext(elemInMainDoc);
      prepareMoveIntoPreviousContainer(elemInMainDoc);
      nPtr++;
      elemInList=elemInList.nextSibling;
      //"вспомним" запомненный элемент
      elemInMainDoc=saveNext;
     }
     if (elemInMainDoc!=myLinks[sortedElementArray[nPtr]]) break;
    }
    finalizeMoveIntoPreviousContainer(false);
    InflateIt(previousSection);
   } //while
   if (elemInMainDoc==parentTitle) {
    parentTitle.removeNode(true);
    moveBlockIntoPreviousBlock();
   }
  } //else (elemInMainDoc!=parentTitle)
 } //while (nPtr<sortedElementArray.length)
 //удалим элементы из списка
 removeReformattedElementsFromList();
} //reformatTitlesToSubtitlesOrText();

function reformat(reformatToWhat) {
 if (selectedElementsCnt==0) { alert("Не выбран ни один элемент."); return; }
 if (currentElementType==reformatToWhat) { alert("Вы пытаетесь преобразовать что-то в то же самое."); return; }
 currentTargetElementType="";
 if (reformatToWhat=="subtitles") currentTargetElementType="subtitle";
 if (reformatToWhat=="text") currentTargetElementType="p";
 if (currentElementType=="titles" && (reformatToWhat=="subtitles"||reformatToWhat=="text")) {
  mainWin.external.BeginUndoUnit(mainDoc,"reformatting "+selectedElementsCnt+" titles as "+reformatToWhat);
  reformatTitlesToSubtitlesOrText();
  mainDoc.selection.empty();
  mainWin.external.EndUndoUnit(mainDoc);
 } else if (currentElementType=="subtitles" && reformatToWhat=="text") {
  mainWin.external.BeginUndoUnit(mainDoc,"reformatting "+selectedElementsCnt+" subtitles as text");
  reformatSubtitlesToText();
  mainDoc.selection.empty();
  mainWin.external.EndUndoUnit(mainDoc);
 }
 else if (currentElementType=="subtitles" && reformatToWhat=="titles") {
  mainWin.external.BeginUndoUnit(mainDoc,"reformatting "+selectedElementsCnt+" subtitles as titles");
  reformatSubtitlesToTitles();
  mainDoc.selection.empty();
  mainWin.external.EndUndoUnit(mainDoc);
 } else if (currentElementType.search(/^(emphasis|strong|sup|sub|strikethrough)$/i)>=0 && reformatToWhat.search(/^(emphasis|strong|sup|sub|strikethrough|text)$/i)>=0) {
  mainWin.external.BeginUndoUnit(mainDoc,"reformatting "+selectedElementsCnt+" subtitles as titles");
  reformatInlineToInlineOrText(reformatToWhat);
  mainDoc.selection.empty();
  mainWin.external.EndUndoUnit(mainDoc);
 }
 else return;
 parent.frame3.document.getElementById("selectedInput").value=selectedElementsCnt.toString();
 parent.frame3.document.getElementById("inAllInput").value=elementsInAll.toString();
}

 </SCRIPT>
</HEAD>
<BODY style="width:100%; height:100%; padding:0; margin:0;" onload="getScrollBarWidthAndHeight();" onkeydown="myOnKeydown();">
<SPAN id=mouseCaptureSpan style="display:none;" onmousemove="capturedMouse();" onmouseout="capturedMouse();" onmouseup="capturedMouse();" onmouseover="capturedMouse();"></SPAN>
<FIELDSET style="width:98%; height:98%; padding:0; white-space:nowrap; margin:1px auto;">
<DIV id=elementList style="width:100%; height:100%; padding:0; overflow:scroll;" onmousedown="myOnMouseDown();" ondblclick="myOnClick();">
<!--
<DIV class=el_><P>Глава 1</P></DIV>
<DIV class=delim></DIV>
<DIV class=el_><P>Глава 2</P><P>Приключения в Тилимилитрямдии</P></DIV>
<DIV class=delim></DIV>
<DIV class=el_><P>Глава 3</P></DIV>
-->
</DIV>
</FIELDSET>
</BODY>
</HTML>
